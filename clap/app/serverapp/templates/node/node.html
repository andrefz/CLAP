{% extends 'base.html' %}

{% block page %}

<script type="text/javascript">
    window.addEventListener('DOMContentLoaded', (event) => {
        put_navigation()
        update_node_list()
        setInterval(update_node_list, 30000)
    });

    function put_navigation(){
        $("#navigation-extra").replaceWith(`
            <li class="nav-item"> <a class="nav-link" href="#" onclick="action_start()">Start</a> </li>
            <li class="nav-item"> <a class="nav-link" href="#" onclick="action_resume()">Resume</a> </li>
            <li class="nav-item"> <a class="nav-link" href="#" onclick="action_stop()">Stop</a> </li>`
        )
    }

    function action_start() {
        console.log('start action called!')
    }

    function action_resume() {
        var table = $('#nodeTable').DataTable()
        var ids = $.map(table.rows('.selected').data(), function (item) {
            return item[0]
        });
        if (ids.length <= 0){
            add_notification('fail', 'You must select at least one node!')
            return
        }
        
        add_notification('success', `Resuming nodes: ${ids}...`)
        $.post('resume', {'node_ids': JSON.stringify(ids)}, function(response){
            add_notification('success', response)
            update_node_list()
        }).fail(function(response){
            add_notification('fail', response.responseText)
            update_node_list()
        });
    }

    function action_stop() {
        console.log('stop action called!')
    }

    function update_node_list(){
        $.get('get-node-list', function(response){
            var table = $('#nodeTable').DataTable()
            table.rows().remove()
            table.destroy()

            table = $('#nodeTable').DataTable()
            for (node in response){
                node_id = response[node]['node_id'];
                node_instance_type = response[node]['instance_type']
                node_status = response[node]['status']
                node_ip = response[node]['ip']
                node_lifecycle = response[node]['lifecycle']
                node_update_time = moment.unix(response[node]['update_time']).toString()
                
                table.row.add([node_id, node_instance_type, node_status, node_ip, node_lifecycle, node_update_time]).draw(true)
            }

            $('#nodeTable tbody').on('click', 'tr', function () {
                $(this).toggleClass('table-active');
                $(this).toggleClass('selected');
            });
        });
    }
    
</script>

<div id="nodeListContainer">
    <div id="nodeListTableDiv" class="table-responsive">
        <table id="nodeTable" class="table">
            <thead>
              <tr>
                <th scope="col">Node</th>
                <th scope="col">Type</th>
                <th scope="col">Status</th>
                <th scope="col">IP</th>
                <th scope="col">Lifecycle</th>
                <th scope="col">Update Time</th>
              </tr>
            </thead>
            
            <tbody>
            </tbody>
          </table>
    </div>

</div>



{% endblock %}